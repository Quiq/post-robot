!function(n,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("postRobot",[],t):"object"==typeof exports?exports.postRobot=t():n.postRobot=t()}("undefined"!=typeof self?self:this,function(){return function(n){var t={};function r(e){if(t[e])return t[e].exports;var o=t[e]={i:e,l:!1,exports:{}};return n[e].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=n,r.c=t,r.d=function(n,t,e){r.o(n,t)||Object.defineProperty(n,t,{configurable:!1,enumerable:!0,get:e})},r.n=function(n){var t=n&&n.__esModule?function(){return n.default}:function(){return n};return r.d(t,"a",t),t},r.o=function(n,t){return Object.prototype.hasOwnProperty.call(n,t)},r.p="",r(r.s=0)}([function(n,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),r.d({},"WeakMap",function(){return k});var e={};function o(n){return"[object RegExp]"===Object.prototype.toString.call(n)}r.d(e,"markWindowKnown",function(){return dn}),r.d(e,"serializeMessage",function(){return xn}),r.d(e,"deserializeMessage",function(){return Dn}),r.d(e,"ProxyWindow",function(){return Rn}),r.d(e,"cleanUpWindow",function(){return st}),r.d(e,"Promise",function(){return x}),r.d(e,"bridge",function(){return wt}),r.d(e,"parent",function(){return ft}),r.d(e,"send",function(){return nt}),r.d(e,"requestPromises",function(){return Vn}),r.d(e,"request",function(){return $n}),r.d(e,"sendToParent",function(){return tt}),r.d(e,"client",function(){return rt}),r.d(e,"on",function(){return it}),r.d(e,"listen",function(){return ot}),r.d(e,"once",function(){return ut}),r.d(e,"listener",function(){return at}),r.d(e,"CONFIG",function(){return Z}),r.d(e,"disable",function(){return ct});var i={MOCK:"mock:",FILE:"file:",ABOUT:"about:"},u="*",a="Call was rejected by callee.\r\n";function c(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:window).location.protocol===i.ABOUT}function f(n){if(n)try{if(n.parent&&n.parent!==n)return n.parent}catch(n){}}function s(n){if(n&&!f(n))try{return n.opener}catch(n){}}function d(n){try{return n&&n.location&&n.location.href,!0}catch(n){}return!1}function l(n){var t=(n=n||window).location;if(!t)throw new Error("Can not read window location");var r=t.protocol;if(!r)throw new Error("Can not read window protocol");if(r===i.FILE)return i.FILE+"//";if(r===i.ABOUT){var e=f(n);return e&&d(e)?l(e):i.ABOUT+"//"}var o=t.host;if(!o)throw new Error("Can not read window host");return r+"//"+o}function w(n){var t=l(n=n||window);return t&&n.mockDomain&&0===n.mockDomain.indexOf(i.MOCK)?n.mockDomain:t}function h(n){try{if(n===window)return!0}catch(n){}try{var t=Object.getOwnPropertyDescriptor(n,"location");if(t&&!1===t.enumerable)return!1}catch(n){}try{if(c(n)&&d(n))return!0}catch(n){}try{if(l(n)===l(window))return!0}catch(n){}return!1}function p(n){if(!h(n))return!1;try{if(n===window)return!0;if(c(n)&&d(n))return!0;if(w(window)===w(n))return!0}catch(n){}return!1}function y(n,t){if(!n||!t)return!1;var r=f(t);return r?r===n:-1!==function(n){var t=[];try{for(;n.parent!==n;)t.push(n.parent),n=n.parent}catch(n){}return t}(t).indexOf(n)}function v(n){var t=[],r=void 0;try{r=n.frames}catch(t){r=n}var e=void 0;try{e=r.length}catch(n){}if(0===e)return t;if(e){for(var o=0;o<e;o++){var i=void 0;try{i=r[o]}catch(n){continue}t.push(i)}return t}for(var u=0;u<100;u++){var a=void 0;try{a=r[u]}catch(n){return t}if(!a)return t;t.push(a)}return t}var m=[],g=[];function E(n){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];try{if(n===window)return!1}catch(n){return!0}try{if(!n)return!0}catch(n){return!0}try{if(n.closed)return!0}catch(n){return!n||n.message!==a}if(t&&p(n))try{if(n.mockclosed)return!0}catch(n){}try{if(!n.parent||!n.top)return!0}catch(n){}var r=function(n,t){for(var r=0;r<n.length;r++)try{if(n[r]===t)return r}catch(n){}return-1}(m,n);if(-1!==r){var e=g[r];if(e&&function(n){if(!n.contentWindow)return!0;if(!n.parentNode)return!0;var t=n.ownerDocument;return!(!t||!t.documentElement||t.documentElement.contains(n))}(e))return!0}return!1}function O(n){return s(n=n||window)||f(n)||void 0}function _(n,t){if("string"==typeof n){if("string"==typeof t)return n===u||t===n;if(o(t))return!1;if(Array.isArray(t))return!1}return o(n)?o(t)?n.toString()===t.toString():!Array.isArray(t)&&Boolean(t.match(n)):!!Array.isArray(n)&&(Array.isArray(t)?JSON.stringify(n)===JSON.stringify(t):!o(t)&&n.some(function(n){return _(n,t)}))}function S(n){try{if(n===window)return!0}catch(n){if(n&&n.message===a)return!0}try{if("[object Window]"===Object.prototype.toString.call(n))return!0}catch(n){if(n&&n.message===a)return!0}try{if(window.Window&&n instanceof window.Window)return!0}catch(n){if(n&&n.message===a)return!0}try{if(n&&n.self===n)return!0}catch(n){if(n&&n.message===a)return!0}try{if(n&&n.parent===n)return!0}catch(n){if(n&&n.message===a)return!0}try{if(n&&n.top===n)return!0}catch(n){if(n&&n.message===a)return!0}try{n&&n.__cross_domain_utils_window_check__}catch(n){return!0}return!1}function W(n){try{if(!n)return!1;if("undefined"!=typeof Promise&&n instanceof Promise)return!0;if("undefined"!=typeof window&&window.Window&&n instanceof window.Window)return!1;if("undefined"!=typeof window&&window.constructor&&n instanceof window.constructor)return!1;var t={}.toString;if(t){var r=t.call(n);if("[object Window]"===r||"[object global]"===r||"[object DOMWindow]"===r)return!1}if("function"==typeof n.then)return!0}catch(n){return!1}return!1}var b=[],R=[],T=0,I=void 0;function N(){if(!T&&I){var n=I;I=null,n.resolve()}}function A(){T+=1}function j(){T-=1,N()}var x=function(){function n(t){var r=this;if(function(t,r){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}(this),this.resolved=!1,this.rejected=!1,this.errorHandled=!1,this.handlers=[],t){var e=void 0,o=void 0,i=!1,u=!1,a=!1;A();try{t(function(n){a?r.resolve(n):(i=!0,e=n)},function(n){a?r.reject(n):(u=!0,o=n)})}catch(n){return j(),void this.reject(n)}j(),a=!0,i?this.resolve(e):u&&this.reject(o)}}return n.prototype.resolve=function(n){if(this.resolved||this.rejected)return this;if(W(n))throw new Error("Can not resolve promise with another promise");return this.resolved=!0,this.value=n,this.dispatch(),this},n.prototype.reject=function(n){var t=this;if(this.resolved||this.rejected)return this;if(W(n))throw new Error("Can not reject promise with another promise");if(!n){var r=n&&"function"==typeof n.toString?n.toString():Object.prototype.toString.call(n);n=new Error("Expected reject to be called with Error, got "+r)}return this.rejected=!0,this.error=n,this.errorHandled||setTimeout(function(){t.errorHandled||function(n,t){if(-1===b.indexOf(n)){b.push(n),setTimeout(function(){throw n},1);for(var r=0;r<R.length;r++)R[r](n,t)}}(n,t)},1),this.dispatch(),this},n.prototype.asyncReject=function(n){return this.errorHandled=!0,this.reject(n),this},n.prototype.dispatch=function(){var t=this,r=this.dispatching,e=this.resolved,o=this.rejected,i=this.handlers;if(!r&&(e||o)){this.dispatching=!0,A();for(var u=function(r){var u=i[r],a=u.onSuccess,c=u.onError,f=u.promise,s=void 0;if(e)try{s=a?a(t.value):t.value}catch(n){return f.reject(n),"continue"}else if(o){if(!c)return f.reject(t.error),"continue";try{s=c(t.error)}catch(n){return f.reject(n),"continue"}}s instanceof n&&(s.resolved||s.rejected)?(s.resolved?f.resolve(s.value):f.reject(s.error),s.errorHandled=!0):W(s)?s instanceof n&&(s.resolved||s.rejected)?s.resolved?f.resolve(s.value):f.reject(s.error):s.then(function(n){f.resolve(n)},function(n){f.reject(n)}):f.resolve(s)},a=0;a<i.length;a++)u(a);i.length=0,this.dispatching=!1,j()}},n.prototype.then=function(t,r){if(t&&"function"!=typeof t&&!t.call)throw new Error("Promise.then expected a function for success handler");if(r&&"function"!=typeof r&&!r.call)throw new Error("Promise.then expected a function for error handler");var e=new n;return this.handlers.push({promise:e,onSuccess:t,onError:r}),this.errorHandled=!0,this.dispatch(),e},n.prototype.catch=function(n){return this.then(void 0,n)},n.prototype.finally=function(t){if(t&&"function"!=typeof t&&!t.call)throw new Error("Promise.finally expected a function");return this.then(function(r){return n.try(t).then(function(){return r})},function(r){return n.try(t).then(function(){throw r})})},n.prototype.timeout=function(n,t){var r=this;if(this.resolved||this.rejected)return this;var e=setTimeout(function(){r.resolved||r.rejected||r.reject(t||new Error("Promise timed out after "+n+"ms"))},n);return this.then(function(n){return clearTimeout(e),n})},n.prototype.toPromise=function(){if("undefined"==typeof Promise)throw new TypeError("Could not find Promise");return Promise.resolve(this)},n.resolve=function(t){return t instanceof n?t:W(t)?new n(function(n,r){return t.then(n,r)}):(new n).resolve(t)},n.reject=function(t){return(new n).reject(t)},n.asyncReject=function(t){return(new n).asyncReject(t)},n.all=function(t){var r=new n,e=t.length,o=[];if(!e)return r.resolve(o),r;for(var i=function(i){var u=t[i];if(u instanceof n){if(u.resolved)return o[i]=u.value,e-=1,"continue"}else if(!W(u))return o[i]=u,e-=1,"continue";n.resolve(u).then(function(n){o[i]=n,0==(e-=1)&&r.resolve(o)},function(n){r.reject(n)})},u=0;u<t.length;u++)i(u);return 0===e&&r.resolve(o),r},n.hash=function(t){var r={};return n.all(Object.keys(t).map(function(e){return n.resolve(t[e]).then(function(n){r[e]=n})})).then(function(){return r})},n.map=function(t,r){return n.all(t.map(r))},n.onPossiblyUnhandledException=function(n){return function(n){return R.push(n),{cancel:function(){R.splice(R.indexOf(n),1)}}}(n)},n.try=function(t,r,e){if(t&&"function"!=typeof t&&!t.call)throw new Error("Promise.try expected a function");var o=void 0;A();try{o=t.apply(r,e||[])}catch(t){return j(),n.reject(t)}return j(),n.resolve(o)},n.delay=function(t){return new n(function(n){setTimeout(n,t)})},n.isPromise=function(t){return!!(t&&t instanceof n)||W(t)},n.flush=function(){return t=I=I||new n,N(),t;var t},n}();function D(n,t){for(var r=0;r<n.length;r++)try{if(n[r]===t)return r}catch(n){}return-1}var P=Object.defineProperty,M=Date.now()%1e9,k=function(){function n(){if(function(t,r){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}(this),M+=1,this.name="__weakmap_"+(1e9*Math.random()>>>0)+"__"+M,function(){if("undefined"==typeof WeakMap)return!1;if(void 0===Object.freeze)return!1;try{var n=new WeakMap,t={};return Object.freeze(t),n.set(t,"__testvalue__"),"__testvalue__"===n.get(t)}catch(n){return!1}}())try{this.weakmap=new WeakMap}catch(n){}this.keys=[],this.values=[]}return n.prototype._cleanupClosedWindows=function(){for(var n=this.weakmap,t=this.keys,r=0;r<t.length;r++){var e=t[r];if(S(e)&&E(e)){if(n)try{n.delete(e)}catch(n){}t.splice(r,1),this.values.splice(r,1),r-=1}}},n.prototype.isSafeToReadWrite=function(n){if(S(n))return!1;try{n&&n.self,n&&n[this.name]}catch(n){return!1}return!0},n.prototype.set=function(n,t){if(!n)throw new Error("WeakMap expected key");var r=this.weakmap;if(r)try{r.set(n,t)}catch(n){delete this.weakmap}if(this.isSafeToReadWrite(n)){var e=this.name,o=n[e];o&&o[0]===n?o[1]=t:P(n,e,{value:[n,t],writable:!0})}else{this._cleanupClosedWindows();var i=this.keys,u=this.values,a=D(i,n);-1===a?(i.push(n),u.push(t)):u[a]=t}},n.prototype.get=function(n){if(!n)throw new Error("WeakMap expected key");var t=this.weakmap;if(t)try{if(t.has(n))return t.get(n)}catch(n){delete this.weakmap}if(!this.isSafeToReadWrite(n)){this._cleanupClosedWindows();var r=D(this.keys,n);if(-1===r)return;return this.values[r]}var e=n[this.name];if(e&&e[0]===n)return e[1]},n.prototype.delete=function(n){if(!n)throw new Error("WeakMap expected key");var t=this.weakmap;if(t)try{t.delete(n)}catch(n){delete this.weakmap}if(this.isSafeToReadWrite(n)){var r=n[this.name];r&&r[0]===n&&(r[0]=r[1]=void 0)}else{this._cleanupClosedWindows();var e=this.keys,o=D(e,n);-1!==o&&(e.splice(o,1),this.values.splice(o,1))}},n.prototype.has=function(n){if(!n)throw new Error("WeakMap expected key");var t=this.weakmap;if(t)try{if(t.has(n))return!0}catch(n){delete this.weakmap}if(this.isSafeToReadWrite(n)){var r=n[this.name];return!(!r||r[0]!==n)}return this._cleanupClosedWindows(),-1!==D(this.keys,n)},n.prototype.getOrSet=function(n,t){if(this.has(n))return this.get(n);var r=t();return this.set(n,r),r},n}(),C="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n};function L(){var n="0123456789abcdef";return"xxxxxxxxxx".replace(/./g,function(){return n.charAt(Math.floor(Math.random()*n.length))})+"_"+function(n){if("function"==typeof btoa)return btoa(n);if("undefined"!=typeof Buffer)return Buffer.from(n,"utf8").toString("base64");throw new Error("Can not find window.btoa or Buffer")}((new Date).toISOString().slice(11,19).replace("T",".")).replace(/[^a-zA-Z0-9]/g,"").toLowerCase()}var U=void 0;function F(){}function z(n){var t=!1;return function(){if(!t)return t=!0,n.apply(this,arguments)}}function B(n){return"[object RegExp]"===Object.prototype.toString.call(n)}function H(n,t,r){if(n.hasOwnProperty(t))return n[t];var e=r();return n[t]=e,e}"function"==typeof Symbol&&Symbol.iterator,Object.assign,Object.create(Error.prototype);var q,G={REQUEST:"postrobot_message_request",RESPONSE:"postrobot_message_response",ACK:"postrobot_message_ack"},K={METHOD:"postrobot_method",HELLO:"postrobot_hello",OPEN_TUNNEL:"postrobot_open_tunnel"},J={POSTROBOT:"__postRobot__quiq__"},X="*",Y={CROSS_DOMAIN_ZALGO_PROMISE:"cross_domain_zalgo_promise",CROSS_DOMAIN_FUNCTION:"cross_domain_function",CROSS_DOMAIN_WINDOW:"cross_domain_window"},Z={BRIDGE_TIMEOUT:5e3,CHILD_WINDOW_TIMEOUT:5e3,ACK_TIMEOUT:2e3,ACK_TIMEOUT_KNOWN:1e4,RES_TIMEOUT:-1,ALLOWED_POST_MESSAGE_METHODS:(q={},q.postrobot_post_message=!0,q.postrobot_bridge=!0,q.postrobot_global=!0,q)},Q=window[J.POSTROBOT]=window[J.POSTROBOT]||{},V=Q.windowStore=Q.windowStore||new k,$=function(){return{}};function nn(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:$;function r(n){return V.getOrSet(n,t)}return{has:function(t){return r(t).hasOwnProperty(n)},get:function(t,e){var o=r(t);return o.hasOwnProperty(n)?o[n]:e},set:function(t,e){return r(t)[n]=e,e},del:function(t){delete r(t)[n]},getOrSet:function(t,e){var o=r(t);if(o.hasOwnProperty(n))return o[n];var i=e();return o[n]=i,i}}}function tn(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:$,r=H(Q,n,t);return{has:function(n){return r.hasOwnProperty(n)},get:function(n,t){return r.hasOwnProperty(n)?r[n]:t},set:function(n,t){return r[n]=t,t},del:function(n){delete r[n]},getOrSet:function(n,t){if(r.hasOwnProperty(n))return r[n];var e=t();return r[n]=e,e},reset:function(){r=t()},keys:function(){return Object.keys(r)}}}Q.instanceID=Q.instanceID||L();var rn=nn("helloPromises");function en(n){return rn.getOrSet(n,function(){return new x})}var on=z(function(){Q.on(K.HELLO,{domain:X},function(n){var t=n.source,r=n.origin;return en(t).resolve({win:t,domain:r}),{instanceID:Q.instanceID}})});function un(n){return Q.send(n,K.HELLO,{instanceID:Q.instanceID},{domain:X,timeout:-1}).then(function(t){var r=t.origin,e=t.data.instanceID;return en(n).resolve({win:n,domain:r}),{win:n,domain:r,instanceID:e}})}var an,cn,fn=(an=function(n){return un(n).then(function(n){return n.instanceID})},cn=new k,function(n){var t=this;return cn.getOrSet(n,function(){return an.call(t,n).finally(function(){cn.delete(n)})})}),sn=nn("knownWindows");function dn(n){sn.set(n,!0)}var ln,wn={FUNCTION:"function",ERROR:"error",PROMISE:"promise",REGEX:"regex",DATE:"date",ARRAY:"array",OBJECT:"object",STRING:"string",NUMBER:"number",BOOLEAN:"boolean",NULL:"null",UNDEFINED:"undefined"},hn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n};function pn(n){return"object"===(void 0===n?"undefined":hn(n))&&null!==n&&"string"==typeof n.__type__}function yn(n){return void 0===n?wn.UNDEFINED:null===n?wn.NULL:Array.isArray(n)?wn.ARRAY:"function"==typeof n?wn.FUNCTION:"object"===(void 0===n?"undefined":hn(n))?n instanceof Error?wn.ERROR:"function"==typeof n.then?wn.PROMISE:"[object RegExp]"===Object.prototype.toString.call(n)?wn.REGEX:"[object Date]"===Object.prototype.toString.call(n)?wn.DATE:wn.OBJECT:"string"==typeof n?wn.STRING:"number"==typeof n?wn.NUMBER:"boolean"==typeof n?wn.BOOLEAN:void 0}function vn(n,t){return{__type__:n,__val__:t}}var mn,gn=((ln={})[wn.FUNCTION]=function(){},ln[wn.ERROR]=function(n){var t=n.message,r=n.stack,e=n.code;return vn(wn.ERROR,{message:t,stack:r,code:e})},ln[wn.PROMISE]=function(){},ln[wn.REGEX]=function(n){return vn(wn.REGEX,n.source)},ln[wn.DATE]=function(n){return vn(wn.DATE,n.toJSON())},ln[wn.ARRAY]=function(n){return n},ln[wn.OBJECT]=function(n){return n},ln[wn.STRING]=function(n){return n},ln[wn.NUMBER]=function(n){return n},ln[wn.BOOLEAN]=function(n){return n},ln[wn.NULL]=function(n){return n},ln),En={},On=((mn={})[wn.FUNCTION]=function(){throw new Error("Function serialization is not implemented; nothing to deserialize")},mn[wn.ERROR]=function(n){var t=n.message,r=n.stack,e=n.code,o=new Error(t);return o.code=e,o.stack=r+"\n\n"+o.stack,o},mn[wn.PROMISE]=function(){throw new Error("Promise serialization is not implemented; nothing to deserialize")},mn[wn.REGEX]=function(n){return new RegExp(n)},mn[wn.DATE]=function(n){return new Date(n)},mn[wn.ARRAY]=function(n){return n},mn[wn.OBJECT]=function(n){return n},mn[wn.STRING]=function(n){return n},mn[wn.NUMBER]=function(n){return n},mn[wn.BOOLEAN]=function(n){return n},mn[wn.NULL]=function(n){return n},mn),_n={},Sn=nn("winToProxyWindow"),Wn=tn("idToProxyWindow");function bn(){for(var n=0,t=Wn.keys(),r=null==t?0:t.length;n<r;n++){var e=t[n];Wn.get(e).shouldClean()&&Wn.del(e)}}var Rn=function(){function n(t,r){!function(t,r){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}(this),this.isProxyWindow=!0,this.serializedWindow=t,this.actualWindowPromise=new x,r&&this.setWindow(r),this.serializedWindow.getInstanceID=function(n){var t={};function r(){for(var r=arguments.length,e=Array(r),o=0;o<r;o++)e[o]=arguments[o];var i=function(n){try{return JSON.stringify(Array.prototype.slice.call(n),function(n,t){return"function"==typeof t?"memoize["+function(n){if(U=U||new k,null===n||void 0===n||"object"!==(void 0===n?"undefined":C(n))&&"function"!=typeof n)throw new Error("Invalid object");var t=U.get(n);return t||(t=(void 0===n?"undefined":C(n))+":"+L(),U.set(n,t)),t}(t)+"]":t})}catch(n){throw new Error("Arguments not serializable -- can not be used to memoize")}}(e);return t.hasOwnProperty(i)?t[i]:(t[i]=n.apply(this,arguments).finally(function(){delete t[i]}),t[i])}return r.reset=function(){t={}},r}(this.serializedWindow.getInstanceID)}return n.prototype.getType=function(){return this.serializedWindow.type},n.prototype.isPopup=function(){return"popup"===this.getType()},n.prototype.isIframe=function(){return"iframe"===this.getType()},n.prototype.setLocation=function(n){var t=this;return x.try(function(){if(!t.actualWindow)return t.serializedWindow.setLocation(n);t.actualWindow.location=n}).then(function(){return t})},n.prototype.setName=function(n){var t=this;return x.try(function(){if(!t.actualWindow)return t.serializedWindow.setName(n);if(!p(t.actualWindow))throw new Error("Can not set name for window on different domain");t.actualWindow.name=n,t.actualWindow.frameElement&&t.actualWindow.frameElement.setAttribute("name",n)}).then(function(){return t})},n.prototype.close=function(){var n=this;return x.try(function(){if(!n.actualWindow)return n.serializedWindow.close();n.actualWindow.close()}).then(function(){return n})},n.prototype.focus=function(){var n=this;return x.try(function(){return n.actualWindow&&n.actualWindow.focus(),n.serializedWindow.focus()}).then(function(){return n})},n.prototype.isClosed=function(){var n=this;return x.try(function(){return n.actualWindow?E(n.actualWindow):n.serializedWindow.isClosed()})},n.prototype.setWindow=function(n){this.actualWindow=n,this.actualWindowPromise.resolve(n)},n.prototype.matchWindow=function(n){var t=this;return x.try(function(){return t.actualWindow?n===t.actualWindow:x.all([t.getInstanceID(),fn(n)]).then(function(r){var e=r[0]===r[1];return e&&t.setWindow(n),e})})},n.prototype.unwrap=function(){return this.actualWindow||this},n.prototype.awaitWindow=function(){return this.actualWindowPromise},n.prototype.getInstanceID=function(){return this.actualWindow?fn(this.actualWindow):this.serializedWindow.getInstanceID()},n.prototype.serialize=function(){return this.serializedWindow},n.prototype.shouldClean=function(){return this.actualWindow&&E(this.actualWindow)},n.unwrap=function(t){return n.isProxyWindow(t)?t.unwrap():t},n.serialize=function(t){return bn(),n.toProxyWindow(t).serialize()},n.deserialize=function(t){return bn(),Wn.getOrSet(t.id,function(){return new n(t)})},n.isProxyWindow=function(n){return Boolean(n&&n.isProxyWindow)},n.toProxyWindow=function(t){return bn(),n.isProxyWindow(t)?t:Sn.getOrSet(t,function(){var r=L();return Wn.set(r,new n({id:r,type:s(t)?"popup":"iframe",getInstanceID:function(){return fn(t)},close:function(){return x.try(function(){t.close()})},focus:function(){return x.try(function(){t.focus()})},isClosed:function(){return x.try(function(){return E(t)})},setLocation:function(n){return x.try(function(){if(p(t))try{if(t.location&&"function"==typeof t.location.replace)return void t.location.replace(n)}catch(n){}t.location=n})},setName:function(n){return x.try(function(){t.name=n})}},t))})},n}(),Tn=Object.assign||function(n){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var e in r)Object.prototype.hasOwnProperty.call(r,e)&&(n[e]=r[e])}return n},In=nn("methodStore"),Nn=tn("proxyWindowMethods");Q.listeningForFunctions=Q.listeningForFunctions||!1;var An=z(function(){Q.listeningForFunctions||(Q.listeningForFunctions=!0,Q.on(K.METHOD,{origin:X},function(n){var t=n.source,r=n.origin,e=n.data,o=e.id,i=e.name;return x.try(function(){var n=In.getOrSet(t,function(){return{}})[e.id]||Nn.get(o);if(!n)throw new Error("Could not find method '"+e.name+"' with id: "+e.id+" in "+w(window));var i=n.proxy,u=n.domain,a=n.val;if(!_(u,r))throw new Error("Method '"+e.name+"' domain "+JSON.stringify(n.domain)+" does not match origin "+r+" in "+w(window));return i?i.matchWindow(t).then(function(n){if(!n)throw new Error("Method call '"+e.name+"' failed - proxy window does not match source in "+w(window));return a}):a}).then(function(n){return n.apply({source:t,origin:r,data:e},e.args)}).then(function(n){return{result:n,id:o,name:i}})}))});function jn(n,t,r,e){An();var o=L();return n=Rn.unwrap(n),Rn.isProxyWindow(n)?(Nn.set(o,{proxy:n,domain:t,val:r}),n.awaitWindow().then(function(n){Nn.del(o),In.getOrSet(n,function(){return{}})[o]={domain:t,val:r}})):In.getOrSet(n,function(){return{}})[o]={domain:t,val:r},vn(Y.CROSS_DOMAIN_FUNCTION,{id:o,name:r.name||e})}function xn(n,t,r){var e;return function(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:En,r=JSON.stringify(n,function(n){var r=this[n];if(pn(this))return r;var e=yn(r);if(!e)return r;var o=t[e]||gn[e];return o?o(r,n):r});return void 0===r?wn.UNDEFINED:r}(r,((e={})[wn.PROMISE]=function(r,e){return function(n,t,r,e){return vn(Y.CROSS_DOMAIN_ZALGO_PROMISE,{then:jn(n,t,function(n,t){return r.then(n,t)},e)})}(n,t,r,e)},e[wn.FUNCTION]=function(r,e){return jn(n,t,r,e)},e[wn.OBJECT]=function(n){return S(n)||Rn.isProxyWindow(n)?(t=n,vn(Y.CROSS_DOMAIN_WINDOW,Rn.serialize(t))):n;var t},e))}function Dn(n,t,r){var e;return function(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:_n;if(n!==wn.UNDEFINED)return JSON.parse(n,function(n,r){if(pn(this))return r;var e=void 0,o=void 0;if(pn(r)?(e=r.__type__,o=r.__val__):(e=yn(r),o=r),!e)return o;var i=t[e]||On[e];return i?i(o,n):o})}(r,((e={})[Y.CROSS_DOMAIN_ZALGO_PROMISE]=function(n){return t=n.then,new x(t);var t},e[Y.CROSS_DOMAIN_FUNCTION]=function(r){return function(n,t,r){var e=r.id,o=r.name;function i(r){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return x.try(function(){return Rn.isProxyWindow(n)?n.awaitWindow():n}).then(function(n){return Q.send(n,K.METHOD,{id:e,name:o,args:r},Tn({domain:t},i))}).catch(function(n){throw n})}function u(){return i(Array.prototype.slice.call(arguments)).then(function(n){return n.data.result})}return u.fireAndForget=function(){return i(Array.prototype.slice.call(arguments),{fireAndForget:!0})},u.__name__=o,u.__xdomain__=!0,u.origin=t,u}(n,t,r)},e[Y.CROSS_DOMAIN_WINDOW]=function(n){return t=n,Rn.deserialize(t);var t},e))}var Pn={postrobot_post_message:function(n,t,r){(Array.isArray(r)?r:"string"==typeof r?[r]:[X]).map(function(t){if(0===t.indexOf("mock:")){if("file:"===window.location.protocol)return X;if(!h(n))throw new Error("Attempting to send messsage to mock domain "+t+", but window is actually cross-domain");return l(n)}return 0===t.indexOf("file:")?X:t}).forEach(function(r){return n.postMessage(t,r)})}},Mn=Object.assign||function(n){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var e in r)Object.prototype.hasOwnProperty.call(r,e)&&(n[e]=r[e])}return n};function kn(n,t,r){return x.try(function(){var e;if(E(n))throw new Error("Window is closed");var o=xn(n,t,((e={})[J.POSTROBOT]=Mn({id:L()},r),e)),i=[];return x.map(Object.keys(Pn),function(r){return x.try(function(){if(!Z.ALLOWED_POST_MESSAGE_METHODS[r])throw new Error("Strategy disallowed: "+r);return Pn[r](n,o,t)}).then(function(){return i.push(r+": success"),!0},function(n){return i.push(r+": "+function n(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(r>=3)return"stringifyError stack overflow";try{if(!t)return"<unknown error: "+Object.prototype.toString.call(t)+">";if("string"==typeof t)return t;if(t instanceof Error){var e=t&&t.stack,o=t&&t.message;if(e&&o)return-1!==e.indexOf(o)?e:o+"\n"+e;if(e)return e;if(o)return o}return"function"==typeof t.toString?t.toString():Object.prototype.toString.call(t)}catch(t){return"Error while stringifying error: "+n(t,r+1)}}(n)+"\n"),!1})}).then(function(n){var t=n.some(Boolean),e=r.type+" "+r.name+" "+(t?"success":"error")+":\n  - "+i.join("\n  - ")+"\n";if(!t)throw new Error(e)})})}var Cn=tn("responseListeners"),Ln=nn("requestListeners"),Un=tn("erroredResponseListeners");Q.WINDOW_WILDCARD=Q.WINDOW_WILDCARD||new function(){};var Fn,zn="__domain_regex__";function Bn(n){return Cn.get(n)}function Hn(n){Cn.del(n)}function qn(n){return Un.has(n)}function Gn(n){var t=n.name,r=n.win,e=n.domain;if(r===X&&(r=null),e===X&&(e=null),!t)throw new Error("Name required to get request listener");for(var o=0,i=[r,Q.WINDOW_WILDCARD],u=null==i?0:i.length;o<u;o++){var a=i[o];if(a){var c=Ln.get(a);if(c){var f=c[t];if(f){if(e&&"string"==typeof e){if(f[e])return f[e];if(f[zn])for(var s=0,d=f[zn],l=null==d?0:d.length;s<l;s++){var w=d[s],h=w.regex,p=w.listener;if(_(h,e))return p}}if(f[X])return f[X]}}}}}var Kn=Object.assign||function(n){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var e in r)Object.prototype.hasOwnProperty.call(r,e)&&(n[e]=r[e])}return n},Jn=((Fn={})[G.REQUEST]=function(n,t,r){var e=Gn({name:r.name,win:n,domain:t});function o(e){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return r.fireAndForget||E(n)?x.resolve():kn(n,t,Kn({type:e,hash:r.hash,name:r.name},o))}return x.all([o(G.ACK),x.try(function(){if(!e)throw new Error("No handler found for post message: "+r.name+" from "+t+" in "+window.location.protocol+"//"+window.location.host+window.location.pathname);if(!_(e.domain,t))throw new Error("Request origin "+t+" does not match domain "+e.domain.toString());var o=r.data;return e.handler({source:n,origin:t,data:o})}).then(function(n){return o(G.RESPONSE,{ack:"success",data:n})},function(n){return o(G.RESPONSE,{ack:"error",error:n})})]).then(F).catch(function(n){if(e&&e.handleError)return e.handleError(n);throw n})},Fn[G.ACK]=function(n,t,r){if(!qn(r.hash)){var e=Bn(r.hash);if(!e)throw new Error("No handler found for post message ack for message: "+r.name+" from "+t+" in "+window.location.protocol+"//"+window.location.host+window.location.pathname);if(!_(e.domain,t))throw new Error("Ack origin "+t+" does not match domain "+e.domain.toString());e.ack=!0}},Fn[G.RESPONSE]=function(n,t,r){if(!qn(r.hash)){var e,i=Bn(r.hash);if(!i)throw new Error("No handler found for post message response for message: "+r.name+" from "+t+" in "+window.location.protocol+"//"+window.location.host+window.location.pathname);if(!_(i.domain,t))throw new Error("Response origin "+t+" does not match domain "+(e=i.domain,Array.isArray(e)?"("+e.join(" | ")+")":o(e)?"RegExp("+e.toString():e.toString()));if(Hn(r.hash),"error"===r.ack)return i.respond(r.error,null);if("success"===r.ack){var u=r.data;return i.respond(null,{source:n,origin:t,data:u})}}},Fn),Xn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n},Yn=tn("receivedMessages");function Zn(n){if(!window||window.closed)throw new Error("Message recieved in closed window");try{if(!n.source)return}catch(n){return}var t=n.source,r=n.origin,e=function(n,t,r){var e=void 0;try{e=Dn(t,r,n)}catch(n){return}if(e&&"object"===(void 0===e?"undefined":Xn(e))&&null!==e&&(e=e[J.POSTROBOT])&&"object"===(void 0===e?"undefined":Xn(e))&&null!==e&&e.type&&"string"==typeof e.type&&Jn[e.type])return e}(n.data,t,r);e&&(dn(t),Yn.has(e.id)||(Yn.set(e.id,!0),E(t)&&!e.fireAndForget||Jn[e.type](t,r,e)))}function Qn(n){try{n.source}catch(n){return}var t={source:n.source||n.sourceElement,origin:n.origin||n.originalEvent&&n.originalEvent.origin,data:n.data};if(t.source){if(!t.origin)throw new Error("Post message did not have origin domain");Zn(t)}}Q.receiveMessage=Zn;var Vn=nn("requestPromises");function $n(n){return x.try(function(){if(!n.name)throw new Error("Expected options.name");var t=n.name,r=void 0,e=void 0;if("string"==typeof n.window){var o=document.getElementById(n.window);if(!o)throw new Error("Expected options.window "+Object.prototype.toString.call(n.window)+" to be a valid element id");if("iframe"!==o.tagName.toLowerCase())throw new Error("Expected options.window "+Object.prototype.toString.call(n.window)+" to be an iframe");if(!o.contentWindow)throw new Error("Iframe must have contentWindow.  Make sure it has a src attribute and is in the DOM.");r=o.contentWindow}else if(n.window instanceof HTMLIFrameElement){if("iframe"!==n.window.tagName.toLowerCase())throw new Error("Expected options.window "+Object.prototype.toString.call(n.window)+" to be an iframe");if(n.window&&!n.window.contentWindow)throw new Error("Iframe must have contentWindow.  Make sure it has a src attribute and is in the DOM.");n.window&&n.window.contentWindow&&(r=n.window.contentWindow)}else r=n.window;if(!r)throw new Error("Expected options.window to be a window object, iframe, or iframe element id.");var i=r;e=n.domain||X;var u=n.name+"_"+L();if(E(i))throw new Error("Target window is closed");var a=!1,c=Vn.getOrSet(i,function(){return[]}),s=x.try(function(){if(function(n,t){var r=O(t);if(r)return r===n;if(t===n)return!1;if(function(n){if(n){try{if(n.top)return n.top}catch(n){}if(f(n)===n)return n;try{if(y(window,n)&&window.top)return window.top}catch(n){}try{if(y(n,window)&&window.top)return window.top}catch(n){}for(var t=0,r=function n(t){for(var r=[],e=0,o=v(t),i=null==o?0:o.length;e<i;e++){var u=o[e];r.push(u);for(var a=0,c=n(u),f=null==c?0:c.length;a<f;a++){var s=c[a];r.push(s)}}return r}(n),e=null==r?0:r.length;t<e;t++){var o=r[t];try{if(o.top)return o.top}catch(n){}if(f(o)===o)return o}}}(t)===t)return!1;for(var e=0,o=v(n),i=null==o?0:o.length;e<i;e++)if(o[e]===t)return!0;return!1}(window,i))return function(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"Window",e=en(n);return-1!==t&&(e=e.timeout(t,new Error(r+" did not load after "+t+"ms"))),e}(i,n.timeout||Z.CHILD_WINDOW_TIMEOUT)}).then(function(){var n=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).domain;if(B(e)&&!n)return un(i)}).then(function(){var r=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).domain;if(B(e)){if(!_(e,r))throw new Error("Remote window domain "+r+" does not match regex: "+e.toString());e=r}if("string"!=typeof e&&!Array.isArray(e))throw new TypeError("Expected domain to be a string or array");var o=e;return new x(function(r,e){var f=void 0;if(n.fireAndForget||function(n,t){Cn.set(n,t)}(u,f={name:t,window:i,domain:o,respond:function(n,t){n||(a=!0,c.splice(c.indexOf(s,1))),n?e(n):r(t)}}),kn(i,o,{type:G.REQUEST,hash:u,name:t,data:n.data,fireAndForget:Boolean(n.fireAndForget)}).catch(e),n.fireAndForget)return r();var d=function(n){return sn.get(n,!1)}(i)?Z.ACK_TIMEOUT_KNOWN:Z.ACK_TIMEOUT,l=n.timeout||Z.RES_TIMEOUT,h=d,p=l,y=100;setTimeout(function n(){if(!a){if(E(i))return f.ack?e(new Error("Window closed for "+t+" before response")):e(new Error("Window closed for "+t+" before ack"));if(h=Math.max(h-y,0),-1!==p&&(p=Math.max(p-y,0)),f.ack){if(-1===p)return;y=Math.min(p,2e3)}else{if(0===h)return e(new Error("No ack for postMessage "+t+" in "+w()+" in "+d+"ms"));if(0===p)return e(new Error("No response for postMessage "+t+" in "+w()+" in "+l+"ms"))}setTimeout(n,y)}},y)})});return s.catch(function(){!function(n){Un.set(n,!0)}(u),Hn(u)}),c.push(s),s})}function nt(n,t,r,e){return(e=e||{}).window=n,e.name=t,e.data=r,$n(e)}function tt(n,t,r){var e=O();return e?nt(e,n,t,r):new x(function(n,t){return t(new Error("Window does not have a parent"))})}function rt(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!n.window)throw new Error("Expected options.window");var t=n.window;return{send:function(r,e){return nt(t,r,e,n)}}}Q.send=nt;var et="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n};function ot(n){if(!n.name)throw new Error("Expected options.name");if(!n.handler)throw new Error("Expected options.handler");var t,r,e,o=n.name,i=n.window,u=n.domain,a={handler:n.handler,handleError:n.errorHandler||function(n){throw n},window:i,domain:u||X,name:o},c=function n(t,r){var e=t.name,o=t.win,i=t.domain;if(!e||"string"!=typeof e)throw new Error("Name required to add request listener");if(Array.isArray(o)){for(var u=[],a=0,c=o,f=null==c?0:c.length;a<f;a++){var s=c[a];u.push(n({name:e,domain:i,win:s},r))}return{cancel:function(){for(var n=0,t=null==u?0:u.length;n<t;n++)u[n].cancel()}}}if(Array.isArray(i)){for(var d=[],l=0,w=i,h=null==w?0:w.length;l<h;l++){var p=w[l];d.push(n({name:e,win:o,domain:p},r))}return{cancel:function(){for(var n=0,t=null==d?0:d.length;n<t;n++)d[n].cancel()}}}var y=Gn({name:e,win:o,domain:i});if(o&&o!==X||(o=Q.WINDOW_WILDCARD),i=i||X,y)throw o&&i?new Error("Request listener already exists for "+e+" on domain "+i.toString()+" for "+(o===Q.WINDOW_WILDCARD?"wildcard":"specified")+" window"):o?new Error("Request listener already exists for "+e+" for "+(o===Q.WINDOW_WILDCARD?"wildcard":"specified")+" window"):i?new Error("Request listener already exists for "+e+" on domain "+i.toString()):new Error("Request listener already exists for "+e);var v=Ln.getOrSet(o,function(){return{}}),m=H(v,e,function(){return{}}),g=i.toString(),E=void 0,O=void 0;return B(i)?(E=H(m,zn,function(){return[]}),O={regex:i,listener:r},E.push(O)):m[g]=r,{cancel:function(){delete m[g],O&&(E.splice(E.indexOf(O,1)),E.length||delete m[zn]),Object.keys(m).length||delete v[e],o&&!Object.keys(v).length&&Ln.del(o)}}}({name:o,win:i,domain:u},a);if(n.once){var f=a.handler;a.handler=z(function(){return c.cancel(),f.apply(this,arguments)})}if(a.window&&n.errorOnClose)var s=(t=function(){i&&"object"===(void 0===i?"undefined":et(i))&&E(i)&&(s.cancel(),a.handleError(new Error("Post message target window is closed")))},r=50,e=void 0,function n(){e=setTimeout(function(){t(),n()},r)}(),{cancel:function(){clearTimeout(e)}});return{cancel:function(){c.cancel()}}}function it(n,t,r){return"function"==typeof t&&(r=t,t={}),(t=t||{}).name=n,t.handler=r||t.handler,ot(t)}function ut(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments[2];"function"==typeof t&&(r=t,t={}),t=t||{},r=r||t.handler;var e=t.errorHandler,o=new x(function(o,i){(t=t||{}).name=n,t.once=!0,t.handler=function(n){if(o(n),r)return r(n)},t.errorHandler=function(n){if(i(n),e)return e(n)}}),i=ot(t);return o.cancel=i.cancel,o}function at(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return{on:function(t,r){return it(t,n,r)}}}function ct(){delete window[J.POSTROBOT],window.removeEventListener("message",Qn)}Q.on=it;var ft=O();function st(n){for(var t=0,r=Vn.get(n,[]),e=null==r?0:r.length;t<e;t++)r[t].reject(new Error("Window cleaned up before response")).catch(F)}var dt,lt,wt=null;Q.initialized||(Q.initialized=!0,dt="message",lt=Qn,window.addEventListener(dt,lt),wt&&wt.openTunnelToOpener(),function(){on();var n=O();n&&un(n).catch(F)}()),r.d(t,"markWindowKnown",function(){return dn}),r.d(t,"serializeMessage",function(){return xn}),r.d(t,"deserializeMessage",function(){return Dn}),r.d(t,"ProxyWindow",function(){return Rn}),r.d(t,"cleanUpWindow",function(){return st}),r.d(t,"Promise",function(){return x}),r.d(t,"bridge",function(){return wt}),r.d(t,"parent",function(){return ft}),r.d(t,"send",function(){return nt}),r.d(t,"requestPromises",function(){return Vn}),r.d(t,"request",function(){return $n}),r.d(t,"sendToParent",function(){return tt}),r.d(t,"client",function(){return rt}),r.d(t,"on",function(){return it}),r.d(t,"listen",function(){return ot}),r.d(t,"once",function(){return ut}),r.d(t,"listener",function(){return at}),r.d(t,"CONFIG",function(){return Z}),r.d(t,"disable",function(){return ct}),t.default=e}])});
//# sourceMappingURL=post-robot.min.js.map